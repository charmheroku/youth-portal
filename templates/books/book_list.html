{% extends "base.html" %}
{% block content %}
  
    {% include "includes/global_search_form.html" %}

  <div class="container mt-5">
      <h1 class="fw-bold text-primary mb-4">üìö Book List</h1>

      {% if books %}
          <div class="list-group">
              {% for book in books %}
                  <div class="list-group-item list-group-item-action p-3 mb-3 shadow-sm">
                      <div class="row g-3">
                          <!-- –û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏ -->
                          <div class="col-md-3 d-flex align-items-center">
                              <img src="{{ book.cover.url|default:'/media/covers/default_cover.jpg' }}" 
                                  alt="Cover" class="img-fluid rounded shadow-sm" 
                                  style="height: 500px; object-fit: cover; width: 100%;">
                          </div>

                          <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ -->
                          <div class="col-md-6">
                              <h5>
                                  <a href="{% url 'books:book_detail' book.pk %}" class="text-dark fw-bold">
                                      {{ book.title }}
                                  </a>
                              </h5>
                              <p class="text-muted mb-2">by <strong>{{ book.author }}</strong></p>
                              <p class="text-muted">
                                  <em>{{ book.description|truncatewords:20 }}</em>
                              </p>
                              <p><strong>Votes:</strong> <span class="badge bg-primary">{{ book.total_votes }}</span></p>

                              <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ —á—Ç–µ–Ω–∏—è -->
                              {% if book.status == "reading" and book.reading_group %}
                                  <hr>
                                  <p><strong>üìñ Reading Group:</strong> 
                                      <a href="{% url 'books:group_detail' book.reading_group.pk %}" class="text-decoration-none">
                                          {{ book.reading_group.book.title }}
                                      </a>
                                  </p>
                                  <p><strong>üë• Participants:</strong> {{ book.reading_group.participants.count }}</p>
                                  <p><strong>üí° Ideas:</strong> {{ book.reading_group.sprints.all|length }}</p>
                              {% endif %}

                              <!-- –ö–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
                              {% if request.user.is_authenticated %}
                                  {% if book.status == "voting" %}
                                      <form action="{% url 'books:toggle_vote' book.pk %}" method="post">
                                          {% csrf_token %}
                                          {% if request.user in book.votes.all %}
                                              <button type="submit" class="btn btn-success">‚úÖ Voted (Remove)</button>
                                          {% else %}
                                              <button type="submit" class="btn btn-outline-primary">üì¢ Vote</button>
                                          {% endif %}
                                      </form>
                                  {% elif book.status == "reading" %}
                                      <p class="text-success"><strong>üìñ Already in Reading</strong></p>
                                  {% endif %}
                              {% endif %}
                          </div>

                          <!-- –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ -->
                          {% if request.user.is_staff %}
                              <div class="col-md-3 d-flex flex-column justify-content-center">
                                  <a href="{% url 'books:book_update' book.pk %}" class="btn btn-sm btn-outline-secondary mb-2">
                                      ‚úè Edit
                                  </a>
                                  <a href="{% url 'books:book_delete' book.pk %}" class="btn btn-sm btn-outline-danger">
                                      üóë Delete
                                  </a>
                                  {% if book.status == "voting" %}
                                      <form action="{% url 'books:finalize_voting' book.pk %}" method="post" class="mt-2">
                                          {% csrf_token %}
                                          <button type="submit" class="btn btn-warning">Finalize Voting & Start Group</button>
                                      </form>
                                  {% endif %}
                              </div>
                          {% endif %}
                      </div>
                  </div>
              {% endfor %}
          </div>
      {% else %}
          <p class="text-center text-muted">No books available.</p>
      {% endif %}

      <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É" –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
      {% if request.user.is_staff %}
          <div class="text-center mt-4">
              <a href="{% url 'books:book_create' %}" class="btn btn-primary btn-lg">‚ûï Add New Book</a>
          </div>
      {% endif %}
  </div>
  {% include 'includes/pagination.html' %}
{% endblock %}
